%!TEX root = Qualificacao.tex

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                              R a C S S                              %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 2021-05-08

\chapter{Randomized Controller Structure Selection}\label{cap:CCS}
\vspace{-1cm}

% Frase citação inicial {{{1
% \begin{flushright}
% \begin{minipage}{0.7\linewidth}
%     \emph{``\dots''}
% \end{minipage}
% \end{flushright}
%
% \begin{flushright}
% Cicrano
% \end{flushright}
%
%\vspace{1cm}

% Intro CAP {{{2

In this chapter, an approach for the design of DDC controllers is presented, based on the RamSS methodology for the choice of structure and on the VRFT method for tuning the controller. This new approach is here called Randomized Controller Structure Selection, or RaCSS, for short.
% In this chapter, proposals for the design of DDC controllers, with regard to the choice of controller structure are presented. The methodology used, as well as the preliminary results obtained in a first stages of this research are presented.

In this research, focus has been given to the study and development of structure selection techniques for the model of feedback controllers in a DDC\@ design fashion.
The intention is, at first, in the scope of non-linear control systems, to adapt known techniques of structure selection in the area of systems identification to deal with the control case, where the system to be identified becomes the controller. To achieve these objectives, it was decided, to use polynomial models to represent the controllers, initially with NARX structures. This choice is convenient due to the structural flexibility characteristic and the ability of these models to describe non-linear systems~\citep{pearson1999, martins2013}.
% \begin{figure}[htpb]
% \centering
% \missingfigure{Pretendo colocar por aqui um diagramas (deve ser blocos) para ajudar.}
% % \includegraphics[width=0.8\textwidth]{}
% \caption{}
% \label{fig:Diagrama representativo}
% \end{figure}
%

As mentioned in Chapter~\ref{cap:cap2}, one of the main steps in the system identification procedure from data is the step of choosing the model structure. Works that aim to help on this task have been proposed, as is the case of the papers published  by~\cite{baldacchino2012,baldacchino2013} and \cite{falsone2014,falsone2015},
\todo{Vou colocar aqui mais referências neste sentido, de seleção de estruturas} 
in which a random approach is used in order to select the best candidates among the possible regressors in the formation of the model to be identified.

% As mentioned in Chapter~\ref{cap:cap2}, one of the main steps in the procedure of model system identification from data is the model selection step.  Studies that aim to deal with this task have been proposed, as is the case of studies developed by~\cite{falsone2014, falsone2015} in which a random approach, named RaMSS, is used in order to select the best candidates to compose a final model structure, among a class of possible regressors.
%
% \todo{Confirmar se o RaMSS original só é aplicável a NARX mesmo na sua forma original. Se for, falar aqui.}
More recently, ~\cite{retesNARMAXModelIdentification2019} extended the RaMSS strategy for choosing NARMAX model structures, which take into account the effect of noise on signals in order to reduce the polarization in parametric estimates.

In the scope of controller design based on data, more specifically by the VRFT method, in which the controller parameters are adjusted by conventional identification techniques such as OLS, ILS, IV, among others, the same problem of choosing the model structure occurs, with the difference that the model now represents the controller, and no longer the process. Therefore, analogies must be able to be made intended to use the RaMSS method in order to extend it for the purpose of identifying the most suitable structure for the controller.

In this sense, the present work has been directed to the study of the possibilities and consequences of using these technologies for control purposes, aiming to choose the most suitable controller structure.

The next section presents the basics of the methodology adopted for the RaCSS procedure, and then, some preliminary results obtained in the first stages of this research are studied.

\todo[inline]{Pretendo colocar um paragrafo aqui comentando o que será apresentado no restante do capítulo.} 


\section{Methodology}\label{sec:CSS_metod} \todo{Talvez colocar o Título como: ``The RaCSS Methodology''"?}
\todo[inline]{A terminar... Vou mexer no início e fim desta seção ainda, enquanto estiver traduzindo.} 

% Visando atingir o objetivo de se utilizar uma estratégia para estrutura e identificação paramétrica de controladores a partir de uma abordagem DDC, pretende-se neste trabalho, fazer uso das duas metodologias abordadas em capítulos anteriores: o VRFT, para sintonia de parâmetros do controlador e o RaMSS, para seleção da melhor estrutura do controlador.
In order to achieve the objective of using a strategy for structural and parametric identification of controllers from a DDC approach, this work intends to make use of the two methodologies covered in previous chapters: VRFT, for tuning controller parameters and RaMSS, to select the best controller structure.
% A partir de do estudo e adaptações de trabalhos anteriores \citep{retesNARMAXModelIdentification2019}, tem-se desenvolvido um algoritmo capaz de unir as duas estratégias com o objetivo de auxiliar tanto na seleção de estruturas, quando na sintodia de controladores não-lieares (ou lineares).
From the study and adaptations of previous works \citep{retesNARMAXModelIdentification2019}, an algorithm has been developed, capable of uniting the two strategies in order to assist in the selection of structures, as in the tuning of non-linear (or linear) controllers.
% O algoritmo tem servido de  framework para estudo e validação da abordagem proposta, a partir de simuações numéricas.
The algorithm has served as a framework for the study and validation of the proposed approach, based on numerical simulations.
% Neste sentido, parte dos esforços da pesquisa tem se voltado para a implemetação numérica deste framework.
In this sense, part of the research efforts has turned to the numerical implementation of this framework.
% Em uma primeira etapa, foi analisado o comportamento do algoritmo na identificação de modelos de processos, a partir do algoritmo RaMSS, como proposto originalmente.
In a first step, the behavior of the algorithm in the identification of process models was analyzed, using the RaMSS algorithm, as originally proposed.
% Alguns dos resultados de validação desta etapa são apresentados no Capítulo \ref{cap:cap2}, sob a forma do Exemplo \ref{ex:varHeater}.
Some of the validation results for this step was presented in Chapter \ref{cap:cap2}, in the form of Example \ref{ex:varHeater}.


% Uma vez validado o funcionamento do algorítmo, o método VRFT, discutido no Capítulo \ref{cap:VRFT} é acrescentado ao processo, de forma que o desempenho do RaMSS em selecionar estruturas para um controlador possa ser avaliado na prática.
Once the behavior of the algorithm has been validated, the VRFT method, discussed in Chapter \ref{cap:VRFT} is added to the process, so that the performance of RaMSS in selecting structures for a controller can be evaluated in practice.
% Nesta etapa, o algoritmo RamSS, utilizado no Capítulo \ref{cap:cap2} é ligeiramente modificado para lidar com a esimação paramétrica via VRFT, para primeiros testes de projeto de controladores.
In this step, the RaMSS algorithm, presented in Chapter \ref{cap:cap2} is slightly modified to deal with parametric estimation via VRFT, for the first tests of controller design.
% Neste cenário se espera alguns primeiros resultados, sem maiores compromissos com bons desempenhos, mas de são de grande valia para análise e comparação das modificações propostas. Alguns destes resuldados são apresentados pelos exemplos da seção \ref{sec:prel_results} a seguir, mais especificamente no exemplo \ref{ex:51}.
In this scenario, some first results are expected, without major commitments with good performances, but they are of great value for analysis and comparison of the proposed modifications. Some of these results are presented by the examples in the Section~\ref{sec:prel_results} below, more specifically in the Example~\ref{ex:sis2aord}.

% Como abordado no Capítulo \ref{cap:VRFT}, sob certas condições, o controlador pode ser identificado por procedimentos tradicionais de identificação de sistemas pelo método VRFT.
As discussed in Chapter \ref{cap:VRFT}, under certain conditions, the controller can be identified by traditional systems identification procedures using the VRFT method.
% Caso as condições necessárias não sejam satisfeitas (vide a Assumption \ref{ass:machedControl} -- matched control) um filtro pode ser projetado de forma que a minimização do índice de custo relativo aos sinais de entrada e saída do controlador, dado por $J_{VR}(\bm{\theta})$ resulte também na minimização do índice de custo $J_{MR}(\bm{\theta})$ relativo ao erro de rastreamento de um modelo de referência.
If the necessary conditions are not met (see Assumption \ref{ass:machedControl} - matched control) a filter can be designed so that the minimization of the cost index related to the input and output signals of the controller, given by $J_{VR}(\bm{\theta})$, also results in the minimization of the $J_{MR}(\bm{\theta})$ cost index related to the tracking error of a reference model.
% Esta relação é garantida pelo filtro desde que a estrutura do modelo não seja muito ``distante'' da estrutura ideal, i.e. desde que não seja muito subparametrizada.
This relationship is guaranteed by the filter as long as the model structure is not too ``distant'' from the ideal structure, i.e. as long as it is not too under-parameterized.

% Uma proposta da presente pesquisa é utilizar o procedimento RaMSS para tentar identificar a estrutura ideal para o controlador, ou pelo menos uma estrutura próxima que gere bons resultados ao se utilizar o procedimento VRFT. A identificação desta estrutura é feita a partir de dados colhidos sob a abordagem VRFT. Na tentativa de validar a proposta simulações são feitas em diferentes cenários.
A proposal of the present research is to use the RaMSS procedure to try to identify the ideal structure for the controller, or at least a close structure that generates good results when using the VRFT procedure. The identification of this structure is made from data collected under the VRFT approach. In an attempt to validate the proposal, simulations are carried out in different scenarios.
% Em um primeiro cenário o procedimento RaMSS é aplicado a um processo linear onde seu modelo e o modelo do controlador ideal são previamente conhecidos. O intuito aqui é analisar o comportamento do procedimento na seleção de regressores candidatos a um eventual controlador. Uma análise ao estilo Monte Carlo é aplicada ao processo em 2 casos: no primeiro, o procedimento é realizado sem influência de ruídos nos dados utilizados; no segundo, ruídos são acrescentados aos dados no intuito de simulação de um ambiente mais realista. O Exemplo \ref{ex:sis2aord} analisa estes casos.
In a first scenario, the RaMSS procedure is applied to a linear process where their model and the model of the ideal controller (matched control) are previously known.
The aim here is to analyze the behavior of the procedure in the selection of candidate regressors for a possible controller.
A randomized analysis is applied to the process in 2 cases: in the first, the procedure is performed without the influence of noise on the data used; in the second, noise is added to the data in order to simulate a more realistic environment.
Example \ ref {ex: sis2aord} analyzes these cases.

% O procedimento RaMSS foi originalmente proposto para lidar com identificação de processos, e não controladores.
The RaMSS procedure was originally proposed to deal with process identification, not controllers.
% A atualização do vetor de probabilidades para inclusão dos regressores (RIPs) é feita baseando-se em índices de desempenho visando avaliar a qualidade de predição do modelo.
The update of the vector of the Regressor Inclusion Probabilities (RIPs) is done based on performance indexes that evaluate the model's prediction quality.
% Esta predição é feita sobre dados de treinamento, utilizando uma versão exponencial do MSPE, e possivelmente, no intuito de aumentar a robustez, sobre dados de validação (free run simulation) por meio de uma versão exponencial do MSSE.
This prediction is made on training data, using an exponential version of MSPE, and possibly, in order to increase robustness on validation data (free run simulation), through an exponential version of MSSE.
% No entanto, para fins de controle, tais índices podem não ser os melhores.
However, for control purposes, these indexes may not be the best.
% Principalmente o índice baseado no MSSE, que exige maior custo computacional sob a proposta de promover melhoras na robustez do modelo identificado. O efeito é uma melhor predição do sinal de saída do do modelo identificado, mesmo quando excitado com sinais diferentes daqueles usados na identificação.
Mainly the index based on MSSE, which requires higher computational cost under the proposal to promote improvements in the robustness of the identified model. The effect is a better prediction of the output signal of the identified model, even when excited with signals different from those used in the identification.
% Apesar de carecer de mais estudos, a princípio este índice não parece trazer muitos benefícios quando utilizado para fins MSS do controlador, uma vez que o intuito final, no projeto de um controlador, é fazer com que o sinal de saída do processo (e não do controlador), tenha um comportamento desejado.
Despite the lack of further studies, at first, this index does not seems to bring many benefits when used for the controller's MSS (Model Structure Selection) purposes, since the main objective, in the design of a controller, is to make the process output (and not the controller's output), behave as desired.

% Neste sentido, propõe-se adaptações ao método RaMSS original visando objetivos mais adequados a MSS de controladores. Uma modificação estudada, é a substituição da versão exponencial do MSSE, dada por $J_s= e^{-K\cdot MSSE}$, por uma que leve em conta o rastreamento do sistema em malha fechada, um dos principais objetivos do controlador. Este novo índice é definido como
In this sense, it is proposed adaptations to the original RaMSS method aiming at objectives more suitable to MSS of controllers. A studied modification at the moment is the replacement of the exponential version of the MSSE, given by $J_s= e^{-K\cdot MSSE}$, by one that takes into account the closed-loop system tracking, one of the main objectives of the controller. This new index is defined as
\begin{equation}
  J_r=e^{-K\cdot MSTE},
  \label{eq:Jr}
\end{equation}
where $MSTE$, is defined here as the mean squared tracking error, given by
\begin{equation}
  MSTE = \frac{1}{N}\sum_{k=1}^{N} (y_{rm}(k)-y(k))^2.
  \label{eq:MSTE}
\end{equation} 

% O índice de desempenho final $\mathcal{J}$, utilizado em $\mathcal{I}$ (vide Equacão \ref{eq:desMedioReg}) para o cálculo dos RIPs, passa a ser calculado por:
The final performance index $\mathcal{J}$, used in $\mathcal{I}$ (see Equation \ref{eq:desMedioReg}) for the computation of RIPs, is now calculated by:
\begin{equation}
  \mathcal{J} = \alpha \mathcal{J}_r + (1-\alpha)\mathcal{J}_p
\label{eq:Jracss}
\end{equation}
% em que $J_p$ continua sendo o mesmo dado por \eqref{eq:Jp}, uma versão exponencial do MSPE. Este novo índice leva em conta o desempenho do controlador em malha fechada no processo de atualização dos RIPs.
where $J_p$ remains the same given by \eqref{eq:Jp}, an exponential version of MSPE. This new index takes into account the performance of the closed loop controller in the process of updating the RIPs.

% Uma vez que a escolha de estrutura é feita pelo método RaMSS modificado, incorporando elementos da estratégia VRFT, e que o intutito é a seleção de estrutura e parâmetros para controladores, batiza-se, aqui, esta estratégia de \textit{Randomized Controler Structure Selection}, ou RaCSS.
Since the choice of structure is made by the modified RaMSS method, incorporating elements of the VRFT strategy, and the aim is the selection of structure and parameters for controllers, this strategy is named here \textit{Randomized Controler Structure Selection }, or RaCSS.

% Resultados preliminares do uso deste índice são apresentados nesta qualificação. Os Exemplos \ref{ex:52} e \ref{ex:53} apresentam alguns destes resultados e uma análise geral é feita no Capítulo \ref{cap:Concl}. \todo{colocar a referencia correta aqui.}
Preliminary results from the use of this index are presented in next sections. Examples \ref{ex:52} and \ref{ex:53} show some of these results and a general analysis is done in Chapter \ref{cap:Concl}.

% Ressalta-se que os resultados apresentados são preliminares e conclusões concretas ainda não puderam ser apresentadas.
\todo{batizar o método de RaCSS.} 
% No Capítulo \ref{cap:Concl}, propostas para continuidade do trabalho, como inclusão de informações auxiliares ao procedimento, objetivando incorporar características previamente desejadas ou conhecidas para o controlador, assim como possivelmente o uso de estratégias de aprendizado por reforço, no intuito de reduzir o custo computacional devido ao uso de informações da malha fechada do controlador são apresentadas.
In Chapter \ref{cap:Concl}, proposals for continuing the work, such as the inclusion of auxiliary information to the procedure, aiming to incorporate previously desired or known characteristics for the controller, as well as possibly the use of reinforcement learning strategies, in order to reduce the computational cost due to the use of closed loop information from the controller are presented.

% Por fim, discussões a respeito de estabilidade, convergência, polarização e robustez são apresentadas, ainda não em um contexto de garantias, mas como conjecturas de passos que pretende-se aprofundar na sequência da presente pesquisa.
Finally, discussions about stability, convergence, polarization and robustness are presented, not yet in a context of guarantees, but as conjectures of steps that we intend to deepen in the sequence of this research.

\section{Preliminary Results}\label{sec:prel_results}

\input{./docs/ex51.tex}

The results discussed in the example \ref{ex:sis2aord}, take into account only one performance of one specific realization. A more realistic analysis would be to consider various realizations, and observe the behavior in the form of statistical distributions. These results are shown in the next example.

\input{./docs/ex52.tex}

Nos exemplos anteriores, o algoritmo RaCSS é analisado para um caso em que o processo é linear e o controlador ideal é conhecido. Na sequência, apresenta-se um exemplo de aplicação para um processo não linear.


\input{./docs/ex53.tex}


% {{{ Anotacoes

% \newpage
% \section{Rascunho}\label{sec:Rascunho}
%
%
% Como produto/trabalho em desenvolvimento durante o semestre, cita-se o trabalho que tem sido feito no sentido de desenvolver metodologias para escolha de estruturas para o controlador no âmbito do controle baseado em dados, ou DDC (Data-Driven Control).
% Mais especificamente, tem-se dado ênfase a escolha da estrutura do controlador a partir do uso de métodos VRFT.
% Como deixa claro em seu nome, ao usar o termo “sintonia” (em inglês, “tunning” ), a metodologia VR  FT visa a sintonia de um controlador pertencente a uma classe de controladores pré-estabelecida.
% Como abordado pelos autores do método~\citep{campi2002,campi2006a}, por outros estudiosos do assunto~\citep{bazanella2012} e apresentado neste relatório na seção de revisão bibliográfica, o método visa minimizar o erro de rastreamento de um modelo de referência pré-definido a partir da minimização de uma função de custo.
% Tal função é definida a partir do erro quadrático entre o sinal de excitação utilizado no processo a se controlar e o sinal de controle “virtual”, gerado pelo controlador identificado ao se aplicar  o mesmo sinal de referência capaz de produzir o mesmo sinal de saída  virtual utilizado na identificação.
%~\cite{campi2002} mostram, para o caso linear, e~\cite{campi2006}  e não linear, que ao se minimizar esta nova função de custos, minimiza-se também o erro de rastreamento, desde que se obedeça os seguintes critérios: a classe do controlador considerado tenha uma estrutura que possibilite abrigar o que se nomeia de controlador ideal (vide eq.
% ); que o processo não seja afetado por ruídos; e o controlador seja parametrizado linearmente.
% Caso o controlador ideal não possa ser representado pela classe considerada, o erro mínimo de rastreamento não é mais garantido e a introdução de um filtro ao projeto, visando se aproximar desse mínimo é desejado.
%
%
% No desenvolvimento do trabalho, foco deste relatório, tem-se feito um estudo de como seria possível, e quais as vantagens poderia-se obter se, ao invés de apenas tentar achar a melhor sintonia para um controlador com estrutura pré-estabelecida,  se procurasse também uma melhor estrutura dentro de um um conjunto de classes de controladores, de forma que o erro de rastreamento ótimo ou pelo menos sub-ótimo possa ser encontrado.
%
% Para atingir este propósito, tem-se investigado o uso de técnicas de seleção de estruturas que, com devidas adaptações e reformulações, sejam capazes selecionar modelos que resultem em controladores não lineares (ou mesmo lineares) que possam levar a respostas melhores do que aqueles que fazem uso de estruturas pré definidas.
%
% Dentre as ferramentas que têm-se utilizado, destacam-se o uso da taxa de redução de erro (ERR) e do algoritmo   Randomized Model Structure Selection (RaMSS)~\citep{falsone2014,falsone2015}. Estas estratégias têm sido estendidas e utilizadas em aplicações para determinação de modelos de processos dinâmicos~\citep{retesNARMAXModelIdentification2019} ou até mesmo no projeto de compensadores para aplicações em que o processo exibe determinados efeitos de não linearidade específicas, como no caso de efeitos histeréticos~\citep{abreuIdentificationNonlinearityCompensation2020}.

% Em particular, o método RaMSS, tem se mostrado promissor para a aplicação desejada. Esse método faz apelo às técnicas exploratórias que recorrem a buscas aleatórias ao estilo Monte Carlo, mas com mecanismos de seleção que reduzem drasticamente o custo computacional, evitando uma busca exaustiva, ao mesmo tempo em que tenta garantir uma seleção adequada.
%
% Apoiado nesta técnica, algumas adaptações têm sido estudadas no sentido de lidar agora com a identificação do controlador, e não mais do processo.
%
% Como abordado na revisão bibliográfica deste relatório, o método RaMSS faz uso de um índice de desempenho baseado no cálculo de alguma grandeza que quantifique a qualidade de o modelo em algum sentido. Uma escolha comum é calcular este índice baseado no erro quadrático médio de predição (MSPE).
%
% Um estudo sobre o uso deste índice tem sido feito na pesquisa em questão, conforme resultados apresentados na seção “Análise e Processamento de Dados”. O que se tem observado é que minimizar o MSPE diretamete pela estratégia RaMSS apesar de muitas vezes apresentar bons resultados, não dá garantias que o rastreamento ótimo é alcançado, i.e. aquele em que o erro de rastreamento médio quadrático por exemplo, é mínimo.
%
% Para sanar  esta deficiência, tem-se considerado o uso de algum índice que leve em conta o resultado final ao se aplicar os controladores intermediários identificados e selecionados pelo procedimento. Algo parecido tem sido usado no que diz respeito a identificação de processos  em que o erro quadrático médio de simulação (MSSE) é utilizado em substituição ao MSPE~\citep{aguirre2010}. Neste caso, segundo~\citep{piroddi2003}, o uso de informações da simulação-livre pode melhorar a robustez na seleção de estrutura do processo quando sob condições de identificabilidade parciais.
%
% O MSSE depende da simulação livre, que em suma é a resposta em malha aberta a um sinal de excitação conhecido. Algo parecido poderia ser utilizado ao se avaliar a estrutura no procedimento VRFT, porém, neste caso, seria desejável a resposta do sistema em malha fechada com o controlador obtido a partir da estrutura avaliada. O grande problema neste caso é que esta simulação passa a ser dependente de um modelo, ainda que aproximado do processo. Porém, como estratégias DDC visam exatamente não identificar um modelo para o processo, tal simulação torna-se inviável.
%
% No atual estágio desta pesquisa, tem-se trabalhado com a ideia de um índice que quantifique o erro médio de rastreamento em função do modelo do controlador sintonizado por uma estratégia VRFT, de modo que alguma informação da resposta em malha fechada com o controlador analisado possa ser usada para  o cálculo dos índices de probabilidades de inclusão do regressor, ou RIP (vide seção de Revisão Bibliográfica). Porém, como a simulação da resposta em malha fechada (ou mesmo malha aberta) é inviável devido a uma falta de modelo para o processo, o que se estuda é o uso de técnicas de Aprendizado por Reforço (RL) para que dados colhidos do processo real, enquanto em funcionamento, possam ser usados para o cálculo em tempo real dos RIP e consequentemente para  escolha de melhor estrutura.
%
% Algumas técnicas de RL se mostram promissoras neste caso, uma vez que muitas vezes levam à otimização de índices de desempenho a partir de dados amostrados, sem a necessidade do modelo do processo, ao mesmo tempo em que evitam o alto número de realizações amostrais como em metodologias Monte Carlo. Dentre elas a estratégia TD Learning, tem sido considerada, com uma atenção ao método conhecido como Q-learning, que permite que um controlador possa ser ajustado em uma abordagem conhecida como off-policy. Nesse caso, um controlador ou lei de controle (no caso do presente trabalho, mais precisamente sua estrutura) pode ser determinado enquanto o sistema em malha fechada obedece a uma lei (ou política) de controle diferente. Isto ajuda em eventuais problemas de instabilidade e exploração.
%
% Durante o semestre tem sido desenvolvido um algoritmo no intuito de implementar as ideiais consideradas anteriormente. Parte do algoritmo desenvolvido por Retes (2018), tem sido aproveitada, assim como algoritmos implementados e desenvolvidos pelo grupo do MACSIN1, grupo do qual o autor faz parte desde o início do doutorado. O algoritmo tem sido desenvolvido na linguagem R, portanto traduções de algumas ferramentas já disponíveis no MACSIN em outras linguagens tiveram e estão tendo que ser adaptadas. Os resultados apresentados na seção “Análise e Processamento de Dados” foram obtidos, em sua maioria, a partir deste algoritmo.


%  }}}
