% simula_modelo_(arquivo)
%% Exemplo 5.1 - Qualificacao
% Simulacao da resposta temporal do modelo gerado no R
% Data: 2021-04-26


modelo_completo=csvread('exp51_resp_temporal_SEM_ruido_case10.csv',1,1);
model_cont1 = modelo_completo(:,2:end)
q1 = modelo_completo(:,1)
modelo_completo=csvread('exp51_resp_temporal_COM_ruido_case10.csv',1,1);
model_cont2 = modelo_completo(:,2:end)
q2 = modelo_completo(:,1)

%% Modelo (Wei & Billings, 2008) - s1
Ts = 1;
nt = 60;
ns = 250;
rho = [-1.7; -0.8; 1; 0.81];
y0 = [0; 0];
model_sis = [1001; 1002; 2001; 2002];



ts = 0:Ts:(ns-1)*Ts;
r = square(2*pi*1/100*ts);
r = [zeros(1,10), r(1:end-10)]';

%% Modelo de referencia
% Parametros desejados:
tau = 5;            % cst de tempo do MR 1a ord
a = exp(-Ts/tau);    % parametro
d = 1;               % atraso puro de tempo
yr = MR1aO(r,a,d,1);
yr=yr';

%% Resposta em Malha fechada
ymf1 = sis_mf(r,model_sis,rho,y0,model_cont1,q1);
ymf2 = sis_mf(r,model_sis,rho,y0,model_cont2,q2);
emf1 = yr-ymf1;
emf2 = yr-ymf2;

%% Fig2 - Resposta temporal y
cor1 = [0  0  0];
cor2 = [0  0  1];
cor3 = [1 0 0];
cor4 = [0  0.5 0];
cores = [cor1; cor2; cor3; cor4];
% col = lines(5); 
corMagnif = [.8 .8 .8];


f2=figure(2); clf;
subplot(3,1,1:2);
   hold on;
   ax=gca;
   ax.ColorOrder = cores;
   plot(ts,yr,':','LineWidth',1);
   stairs(ts,ymf1,'LineWidth',1);
   stairs(ts,ymf2,'--','LineWidth',1);
   % set(gca,'Xticklabel',[])
   ylabel('output')
   ylim([-1.5 1.5])
   set(gca,'XTick',[]
   
   MagInset2(f2,ax,[74 102 0.95 1.1],[110 150 0 1.5],{'NE','NW';'SE','SW'},corMagnif,corMagnif,corMagnif);
   set(gca,'YTick',[],'XTick',[])
   rangeY=[0.96 1.001];

   MagInset2(f2,ax,[170 200 rangeY],[175 250 -1.25 0.3],{'SW','NW';'SE','NE'},corMagnif,corMagnif,corMagnif);
   set(gca,'YTick',[rangeY],'XTick',[])
   set(ax,'colororder',col)
   % set(ax,'Visible','off')
   %
subplot(3,1,3)
   hold on;
   ax=gca;
   ax.ColorOrder = cores(2:end,:);
   corMagnif = [.8 .8 .8];
   stairs(ts,emf1,'LineWidth',1);
   stairs(ts,emf2,'--','LineWidth',1);
   ylabel('abs. error')
   xlabel('iteration ($k$)');
   MagInset2(f2,gca,[85 142 0 0.1],[118 248 0.2 0.6],{'NW','SW';'NE','SE'},corMagnif,corMagnif,corMagnif);
   set(gca,'YTick',[],'XTick',[])
   ax=gca;
   % ax.XColor = corMagnif; ax.YColor = corMagnif;
   axesHandlesToAllLines = findobj(f2, 'Type', 'line')
% axesHandlesToAllLines.Color(1) = corMagnif